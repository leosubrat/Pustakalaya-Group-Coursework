<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PustalaJaya - Admin Dashboard</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #ff8c00;
            --light-color: #ecf0f1;
            --dark-color: #1a252f;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
            --info-color: #3498db;
            --warning-color: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
            padding-left: 250px;
            transition: padding-left 0.3s ease;
        }

            body.collapsed {
                padding-left: 70px;
            }

        /* Sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100vh;
            background-color: var(--primary-color);
            color: white;
            transition: width 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

            .sidebar.collapsed {
                width: 70px;
            }

        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
        }

            .sidebar-header .logo-full {
                font-size: 1.5rem;
                font-weight: 700;
                color: white;
                text-decoration: none;
                display: flex;
                align-items: center;
            }

                .sidebar-header .logo-full span {
                    color: var(--secondary-color);
                }

            .sidebar-header .logo-icon {
                display: none;
                font-size: 1.5rem;
                font-weight: 700;
                color: white;
                text-decoration: none;
                text-align: center;
            }

        .collapsed .sidebar-header .logo-full {
            display: none;
        }

        .collapsed .sidebar-header .logo-icon {
            display: block;
        }

        .sidebar-toggle {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            margin-left: auto;
            padding: 5px;
            transition: transform 0.3s ease;
        }

        .collapsed .sidebar-toggle {
            transform: rotate(180deg);
        }

        .nav-label {
            display: block;
            transition: opacity 0.3s ease;
        }

        .collapsed .nav-label {
            display: none;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

            .sidebar-nav .nav-item {
                margin-bottom: 0.5rem;
            }

            .sidebar-nav .nav-link {
                color: rgba(255, 255, 255, 0.7);
                padding: 0.75rem 1rem;
                transition: all 0.3s ease;
                border-left: 3px solid transparent;
                display: flex;
                align-items: center;
                text-decoration: none;
            }

                .sidebar-nav .nav-link:hover,
                .sidebar-nav .nav-link.active {
                    color: white;
                    background-color: rgba(255, 255, 255, 0.1);
                    border-left-color: var(--secondary-color);
                }

                .sidebar-nav .nav-link i {
                    margin-right: 15px;
                    min-width: 20px;
                    text-align: center;
                }

        .collapsed .sidebar-nav .nav-link {
            text-align: center;
            padding: 0.75rem 0;
        }

            .collapsed .sidebar-nav .nav-link i {
                margin-right: 0;
            }

        .sidebar-heading {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .collapsed .sidebar-heading {
            text-align: center;
            padding: 1rem 0;
        }

        .sidebar-divider {
            height: 0;
            margin: 1rem 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-panel {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
            display: flex;
            align-items: center;
        }

            .user-panel img {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
                margin-right: 10px;
            }

            .user-panel .user-info {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

        .collapsed .user-panel {
            justify-content: center;
            padding: 1rem 0;
        }

            .collapsed .user-panel img {
                margin-right: 0;
            }

            .collapsed .user-panel .user-info {
                display: none;
            }

        /* Main content */
        .main-content {
            padding: 2rem;
            transition: padding-left 0.3s ease;
        }

        .page-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 0.5rem;
            display: inline-block;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #f0f0f0;
            padding: 1.25rem 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .stats-card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

            .stats-card:hover {
                transform: translateY(-5px);
            }

            .stats-card .stats-icon {
                position: absolute;
                right: 1.5rem;
                top: 1.5rem;
                font-size: 2.5rem;
                opacity: 0.2;
            }

            .stats-card .stats-title {
                font-size: 0.9rem;
                color: #777;
                margin-bottom: 0.5rem;
            }

            .stats-card .stats-value {
                font-size: 2rem;
                font-weight: 700;
                color: var(--primary-color);
                margin-bottom: 0.5rem;
            }

            .stats-card .stats-change {
                font-size: 0.8rem;
            }

                .stats-card .stats-change.positive {
                    color: var(--success-color);
                }

                .stats-card .stats-change.negative {
                    color: var(--danger-color);
                }

        .stats-primary {
            border-left: 4px solid var(--primary-color);
        }

        .stats-success {
            border-left: 4px solid var(--success-color);
        }

        .stats-danger {
            border-left: 4px solid var(--danger-color);
        }

        .stats-warning {
            border-left: 4px solid var(--warning-color);
        }

        /* Form styles */
        .form-label {
            font-weight: 500;
            color: var(--primary-color);
        }

        .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.25rem rgba(255, 140, 0, 0.15);
        }

        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

            .btn-primary:hover, .btn-primary:focus {
                background-color: #e67e00;
                border-color: #e67e00;
            }

        .btn-outline-primary {
            color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

            .btn-outline-primary:hover {
                background-color: var(--secondary-color);
                border-color: var(--secondary-color);
            }

        /* Table styles */
        .table {
            margin-top: 1rem;
        }

            .table thead {
                background-color: #f8f9fa;
            }

            .table th {
                font-weight: 500;
                color: var(--primary-color);
            }

        .table-action {
            width: 100px;
        }

            .table-action .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.875rem;
            }

        .table-image {
            width: 50px;
            height: 70px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* Utility classes */
        .text-primary {
            color: var(--primary-color) !important;
        }

        .text-secondary {
            color: var(--secondary-color) !important;
        }

        .bg-primary {
            background-color: var(--primary-color) !important;
        }

        .bg-secondary {
            background-color: var(--secondary-color) !important;
        }

        /* Responsive */
        @media (max-width: 991.98px) {
            body {
                padding-left: 0;
            }

                body.collapsed {
                    padding-left: 0;
                }

            .sidebar {
                left: -250px;
            }

                .sidebar.collapsed {
                    left: 0;
                }

            .mobile-toggle {
                display: block !important;
            }
        }

        .mobile-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1050;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            width: 40px;
            height: 40px;
            text-align: center;
            line-height: 40px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        /* Switch styling */
        .form-switch .form-check-input {
            width: 3em;
            height: 1.5em;
        }

            .form-switch .form-check-input:checked {
                background-color: var(--success-color);
                border-color: var(--success-color);
            }

        /* Date range picker styling */
        .daterange-container {
            position: relative;
        }

            .daterange-container .input-group-text {
                cursor: pointer;
                background-color: #fff;
            }

        /* Announcement styling */
        .announcement-card {
            border-left: 4px solid var(--info-color);
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

            .announcement-card .announcement-title {
                font-weight: 600;
                margin-bottom: 0.5rem;
            }

            .announcement-card .announcement-dates {
                font-size: 0.8rem;
                color: #777;
                margin-bottom: 0.5rem;
            }

            .announcement-card .announcement-text {
                margin-bottom: 0;
            }

        /* Tab styling */
        .nav-tabs {
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 1.5rem;
        }

            .nav-tabs .nav-link {
                border: none;
                color: #777;
                font-weight: 500;
                padding: 0.75rem 1rem;
                margin-right: 0.5rem;
                transition: color 0.3s ease;
            }

                .nav-tabs .nav-link.active {
                    color: var(--secondary-color);
                    border-bottom: 2px solid var(--secondary-color);
                    background-color: transparent;
                }

                .nav-tabs .nav-link:hover {
                    color: var(--secondary-color);
                }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 4px;
        }

            ::-webkit-scrollbar-thumb:hover {
                background: #ccc;
            }

        /* Toast styling */
        #toast-container {
            z-index: 1100;
        }
    </style>

    <!-- API utility script -->
    <script>
        // API utility functions
        const API = {
            baseUrl: '/api',

            // Get the authentication token from localStorage
            getToken() {
                return localStorage.getItem('token');
            },

            // Check if user is authenticated
            isAuthenticated() {
                return !!this.getToken();
            },

            // Check if user is admin
            isAdmin() {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                return user.role === 'Admin';
            },

            // API request with authentication
            async fetch(endpoint, options = {}) {
                const url = `${this.baseUrl}${endpoint}`;

                // Default headers
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                // Add authorization header if token exists
                if (this.getToken()) {
                    headers['Authorization'] = `Bearer ${this.getToken()}`;
                }

                try {
                    const response = await fetch(url, {
                        ...options,
                        headers
                    });

                    // Handle unauthorized access
                    if (response.status === 401) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = '/login.html';
                        return null;
                    }

                    // Parse JSON response if available
                    if (response.headers.get('content-type')?.includes('application/json')) {
                        const data = await response.json();
                        return { success: response.ok, data, status: response.status };
                    }

                    return { success: response.ok, status: response.status };
                } catch (error) {
                    console.error('API Request failed:', error);
                    return { success: false, error: error.message };
                }
            },

            // GET request
            async get(endpoint) {
                return this.fetch(endpoint, { method: 'GET' });
            },

            // POST request
            async post(endpoint, data) {
                return this.fetch(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            },

            // PUT request
            async put(endpoint, data) {
                return this.fetch(endpoint, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            },

            // DELETE request
            async delete(endpoint) {
                return this.fetch(endpoint, { method: 'DELETE' });
            }
        };

        // Check if user is authenticated and has admin role
        function checkAuthentication() {
            if (!API.isAuthenticated()) {
                window.location.href = '/login.html';
                return false;
            }

            if (!API.isAdmin()) {
                alert('You do not have permission to access this page');
                window.location.href = '/dashboard.html';
                return false;
            }

            return true;
        }

        // Format date string to YYYY-MM-DD
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }

        // Display toast notification
        function showToast(message, type = 'success') {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }

            // Create toast element
            const toastId = `toast-${Date.now()}`;
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.id = toastId;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');

            toast.innerHTML = `
                            <div class="d-flex">
                                <div class="toast-body">
                                    ${message}
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        `;

            toastContainer.appendChild(toast);

            // Initialize and show toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            // Remove toast after it's hidden
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Debounce function to limit API calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</head>
<body>
    <!-- Mobile Toggle Button -->
    <button class="mobile-toggle" id="mobileToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#" class="logo-full">Pustaka<span>Laya</span></a>
            <a href="#" class="logo-icon">P<span>L</span></a>
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>

        <div class="sidebar-nav">
            <a href="admin-dashboard.html" class="nav-link active">
                <i class="fas fa-tachometer-alt"></i>
                <span class="nav-label">Dashboard</span>
            </a>
            <a href="admin-books.html" class="nav-link">
                <i class="fas fa-book"></i>
                <span class="nav-label">Books</span>
            </a>
            <a href="admin-inventory.html" class="nav-link">
                <i class="fas fa-box"></i>
                <span class="nav-label">Inventory</span>
            </a>
            <a href="admin-orders.html" class="nav-link">
                <i class="fas fa-shopping-cart"></i>
                <span class="nav-label">Orders</span>
            </a>
            <a href="admin-members.html" class="nav-link">
                <i class="fas fa-users"></i>
                <span class="nav-label">Members</span>
            </a>
            <a href="admin-staff.html" class="nav-link">
                <i class="fas fa-user-tie"></i>
                <span class="nav-label">Staff</span>
            </a>
            <a href="admin-announcements.html" class="nav-link">
                <i class="fas fa-bullhorn"></i>
                <span class="nav-label">Announcements</span>
            </a>
            <a href="admin-reports.html" class="nav-link">
                <i class="fas fa-chart-bar"></i>
                <span class="nav-label">Reports</span>
            </a>

            <div class="sidebar-divider"></div>

            <a href="#" class="nav-link" id="logoutLink">
                <i class="fas fa-sign-out-alt"></i>
                <span class="nav-label">Logout</span>
            </a>
        </div>

        <div class="user-panel">
            <img src="https://ui-avatars.com/api/?name=Admin+User&background=ff8c00&color=fff" alt="Admin User" id="userAvatar">
            <div class="user-info">
                <div class="user-name" id="userName">Admin User</div>
                <div class="user-role">Administrator</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <h1 class="page-title">Admin Dashboard</h1>

        <!-- Stats Cards -->
        <div class="row">
            <div class="col-md-6 col-lg-3">
                <div class="stats-card stats-primary">
                    <i class="fas fa-book stats-icon"></i>
                    <div class="stats-title">Total Books</div>
                    <div class="stats-value" id="totalBooks">0</div>
                    <div class="stats-change positive">
                        <i class="fas fa-arrow-up"></i> Updated today
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="stats-card stats-success">
                    <i class="fas fa-shopping-cart stats-icon"></i>
                    <div class="stats-title">Orders</div>
                    <div class="stats-value" id="totalOrders">0</div>
                    <div class="stats-change positive">
                        <i class="fas fa-arrow-up"></i> Updated today
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="stats-card stats-warning">
                    <i class="fas fa-users stats-icon"></i>
                    <div class="stats-title">Members</div>
                    <div class="stats-value" id="totalMembers">0</div>
                    <div class="stats-change positive">
                        <i class="fas fa-arrow-up"></i> Updated today
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="stats-card stats-danger">
                    <i class="fas fa-exclamation-triangle stats-icon"></i>
                    <div class="stats-title">Low Stock</div>
                    <div class="stats-value" id="lowStockBooks">0</div>
                    <div class="stats-change negative">
                        <i class="fas fa-arrow-up"></i> Updated today
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Tabs -->
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="manage-books-tab" data-bs-toggle="tab" data-bs-target="#manage-books" type="button" role="tab" aria-controls="manage-books" aria-selected="true">Manage Books</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="manage-discounts-tab" data-bs-toggle="tab" data-bs-target="#manage-discounts" type="button" role="tab" aria-controls="manage-discounts" aria-selected="false">Manage Discounts</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="manage-announcements-tab" data-bs-toggle="tab" data-bs-target="#manage-announcements" type="button" role="tab" aria-controls="manage-announcements" aria-selected="false">Manage Announcements</button>
            </li>
        </ul>

        <div class="tab-content" id="adminTabContent">
            <!-- Manage Books Tab -->
            <div class="tab-pane fade show active" id="manage-books" role="tabpanel" aria-labelledby="manage-books-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>Add/Edit Book</div>
                        <button type="button" class="btn btn-sm btn-primary" id="resetBookForm">
                            <i class="fas fa-plus"></i> New Book
                        </button>
                    </div>
                    <div class="card-body">
                        <form id="bookForm">
                            <input type="hidden" id="bookId">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="title" class="form-label">Title</label>
                                        <input type="text" class="form-control" id="title" name="title" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="author" class="form-label">Author</label>
                                        <input type="text" class="form-control" id="author" name="author" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="isbn" class="form-label">ISBN</label>
                                        <input type="text" class="form-control" id="isbn" name="isbn" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="publisher" class="form-label">Publisher</label>
                                        <input type="text" class="form-control" id="publisher" name="publisher" required>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="publicationDate" class="form-label">Publication Date</label>
                                                <input type="date" class="form-control" id="publicationDate" name="publicationDate" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="language" class="form-label">Language</label>
                                                <select class="form-select" id="language" name="language" required>
                                                    <option value="" selected disabled>Select Language</option>
                                                    <option value="English">English</option>
                                                    <option value="Spanish">Spanish</option>
                                                    <option value="French">French</option>
                                                    <option value="German">German</option>
                                                    <option value="Japanese">Japanese</option>
                                                    <option value="Chinese">Chinese</option>
                                                    <option value="Russian">Russian</option>
                                                    <option value="Arabic">Arabic</option>
                                                    <option value="Hindi">Hindi</option>
                                                    <option value="Nepali">Nepali</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="genre" class="form-label">Genre</label>
                                        <select class="form-select" id="genre" name="genre" required>
                                            <option value="" selected disabled>Select Genre</option>
                                            <option value="Fiction">Fiction</option>
                                            <option value="Non-Fiction">Non-Fiction</option>
                                            <option value="Mystery">Mystery</option>
                                            <option value="Science Fiction">Science Fiction</option>
                                            <option value="Fantasy">Fantasy</option>
                                            <option value="Romance">Romance</option>
                                            <option value="Thriller">Thriller</option>
                                            <option value="Horror">Horror</option>
                                            <option value="Biography">Biography</option>
                                            <option value="History">History</option>
                                            <option value="Self-Help">Self-Help</option>
                                            <option value="Business">Business</option>
                                            <option value="Children">Children</option>
                                            <option value="Young Adult">Young Adult</option>
                                            <option value="Poetry">Poetry</option>
                                            <option value="Travel">Travel</option>
                                            <option value="Cooking">Cooking</option>
                                            <option value="Art">Art</option>
                                            <option value="Religion">Religion</option>
                                            <option value="Science">Science</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="description" class="form-label">Description</label>
                                        <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="price" class="form-label">Price ($)</label>
                                                <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="stock" class="form-label">Stock Quantity</label>
                                                <input type="number" class="form-control" id="stock" name="stock" min="0" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="format" class="form-label">Format</label>
                                        <select class="form-select" id="format" name="format" required>
                                            <option value="" selected disabled>Select Format</option>
                                            <option value="Paperback">Paperback</option>
                                            <option value="Hardcover">Hardcover</option>
                                            <option value="E-Book">E-Book</option>
                                            <option value="Audiobook">Audiobook</option>
                                            <option value="Limited Edition">Limited Edition</option>
                                            <option value="Signed Edition">Signed Edition</option>
                                            <option value="First Edition">First Edition</option>
                                            <option value="Collector's Edition">Collector's Edition</option>
                                            <option value="Deluxe Edition">Deluxe Edition</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="coverImage" class="form-label">Cover Image URL</label>
                                        <input type="url" class="form-control" id="coverImage" name="coverImage" required>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="isBestseller" name="isBestseller">
                                                <label class="form-check-label" for="isBestseller">Bestseller</label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="isNewRelease" name="isNewRelease">
                                                <label class="form-check-label" for="isNewRelease">New Release</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="isAwardWinner" name="isAwardWinner">
                                                <label class="form-check-label" for="isAwardWinner">Award Winner</label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="isComingSoon" name="isComingSoon">
                                                <label class="form-check-label" for="isComingSoon">Coming Soon</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                                <button type="reset" class="btn btn-outline-secondary me-md-2">Reset</button>
                                <button type="submit" class="btn btn-primary">Save Book</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>Book Catalogue</div>
                        <div class="d-flex">
                            <input type="text" class="form-control form-control-sm me-2" id="searchBook" placeholder="Search books...">
                            <select class="form-select form-select-sm" id="filterBooks" style="width: 150px;">
                                <option value="all">All Books</option>
                                <option value="bestseller">Bestsellers</option>
                                <option value="newRelease">New Releases</option>
                                <option value="awardWinner">Award Winners</option>
                                <option value="lowStock">Low Stock</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Cover</th>
                                        <th>Title</th>
                                        <th>Author</th>
                                        <th>Genre</th>
                                        <th>Price ($)</th>
                                        <th>Stock</th>
                                        <th>Status</th>
                                        <th class="table-action">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="booksTableBody">
                                    <!-- Book entries will be dynamically generated -->
                                    <tr>
                                        <td colspan="8" class="text-center">Loading books...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination -->
                        <nav aria-label="Book table pagination" class="mt-4">
                            <ul class="pagination justify-content-center" id="bookPagination">
                                <!-- Pagination will be generated dynamically -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- Manage Discounts Tab -->
            <div class="tab-pane fade" id="manage-discounts" role="tabpanel" aria-labelledby="manage-discounts-tab">
                <div class="card">
                    <div class="card-header">Set Book Discount</div>
                    <div class="card-body">
                        <form id="discountForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="selectBook" class="form-label">Select Book</label>
                                        <select class="form-select" id="selectBook" name="selectBook" required>
                                            <option value="" selected disabled>Choose a book</option>
                                            <!-- Book options will be dynamically generated -->
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="discountPercent" class="form-label">Discount Percentage (%)</label>
                                        <input type="number" class="form-control" id="discountPercent" name="discountPercent" min="1" max="99" required>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="isOnSale" name="isOnSale">
                                            <label class="form-check-label" for="isOnSale">Mark as "On Sale"</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="discountStartDate" class="form-label">Start Date</label>
                                        <input type="date" class="form-control" id="discountStartDate" name="discountStartDate" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="discountEndDate" class="form-label">End Date</label>
                                        <input type="date" class="form-control" id="discountEndDate" name="discountEndDate" required>
                                    </div>
                                </div>
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                                <button type="reset" class="btn btn-outline-secondary me-md-2">Reset</button>
                                <button type="submit" class="btn btn-primary">Apply Discount</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">Active Discounts</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Book Title</th>
                                        <th>Discount</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>On Sale</th>
                                        <th>Status</th>
                                        <th class="table-action">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="discountsTableBody">
                                    <!-- Discount entries will be dynamically generated -->
                                    <tr>
                                        <td colspan="7" class="text-center">Loading discounts...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Announcements Tab -->
            <div class="tab-pane fade" id="manage-announcements" role="tabpanel" aria-labelledby="manage-announcements-tab">
                <div class="card">
                    <div class="card-header">Create Announcement</div>
                    <div class="card-body">
                        <form id="announcementForm">
                            <input type="hidden" id="announcementId">
                            <div class="mb-3">
                                <label for="announcementTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="announcementTitle" name="announcementTitle" required>
                            </div>
                            <div class="mb-3">
                                <label for="announcementText" class="form-label">Announcement Text</label>
                                <textarea class="form-control" id="announcementText" name="announcementText" rows="3" required></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="announcementStartDate" class="form-label">Start Date</label>
                                        <input type="date" class="form-control" id="announcementStartDate" name="announcementStartDate" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="announcementEndDate" class="form-label">End Date</label>
                                        <input type="date" class="form-control" id="announcementEndDate" name="announcementEndDate" required>
                                    </div>
                                </div>
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                                <button type="reset" class="btn btn-outline-secondary me-md-2">Reset</button>
                                <button type="submit" class="btn btn-primary">Post Announcement</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">Current Announcements</div>
                    <div class="card-body" id="announcementsContainer">
                        <!-- Announcements will be dynamically generated -->
                        <p class="text-center">Loading announcements...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this item? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="position-fixed bottom-0 end-0 p-3"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Check authentication
            if (!checkAuthentication()) return;

            // Initialize variables
            let currentPage = 1;
            let itemsPerPage = 10;
            let totalPages = 1;
            let itemToDelete = null;
            const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

            // Load dashboard data
            loadDashboardStats();
            loadBooks();
            loadDiscounts();
            loadAnnouncements();

            // Set up user info
            setupUserInfo();

            // Sidebar toggle
            const sidebarToggle = document.getElementById('sidebarToggle');
            const mobileToggle = document.getElementById('mobileToggle');
            const sidebar = document.getElementById('sidebar');
            const body = document.body;

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function () {
                    sidebar.classList.toggle('collapsed');
                    body.classList.toggle('collapsed');
                });
            }

            if (mobileToggle) {
                mobileToggle.addEventListener('click', function () {
                    sidebar.classList.toggle('collapsed');
                });
            }

            // Reset book form
            const resetBookFormBtn = document.getElementById('resetBookForm');
            const bookForm = document.getElementById('bookForm');

            if (resetBookFormBtn && bookForm) {
                resetBookFormBtn.addEventListener('click', function () {
                    bookForm.reset();
                    document.getElementById('bookId').value = '';
                });
            }

            // Book form submission
            if (bookForm) {
                bookForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const bookId = document.getElementById('bookId').value;
                    const bookData = {
                        title: document.getElementById('title').value,
                        isbn: document.getElementById('isbn').value,
                        description: document.getElementById('description').value,
                        author: document.getElementById('author').value,
                        genre: document.getElementById('genre').value,
                        publisher: document.getElementById('publisher').value,
                        language: document.getElementById('language').value,
                        format: document.getElementById('format').value,
                        price: parseFloat(document.getElementById('price').value),
                        stockQuantity: parseInt(document.getElementById('stock').value),
                        publicationDate: document.getElementById('publicationDate').value,
                        isAvailableInLibrary: true,
                        isBestseller: document.getElementById('isBestseller').checked,
                        isAwardWinner: document.getElementById('isAwardWinner').checked,
                        isComingSoon: document.getElementById('isComingSoon').checked,
                        imageUrl: document.getElementById('coverImage').value
                    };

                    try {
                        let response;

                        if (bookId) {
                            // Update existing book
                            response = await API.put(`/books/${bookId}`, bookData);
                            if (response.success) {
                                showToast('Book updated successfully');
                            }
                        } else {
                            // Create new book
                            response = await API.post('/books', bookData);
                            if (response.success) {
                                showToast('Book added successfully');
                            }
                        }

                        if (response.success) {
                            // Reset form and refresh book list
                            bookForm.reset();
                            document.getElementById('bookId').value = '';
                            loadBooks();
                            // Refresh statistics
                            loadDashboardStats();
                        } else {
                            showToast(response.data?.message || 'Error saving book', 'danger');
                        }
                    } catch (error) {
                        console.error('Error saving book:', error);
                        showToast('An error occurred while saving the book', 'danger');
                    }
                });
            }

            // Discount form submission
            const discountForm = document.getElementById('discountForm');
            if (discountForm) {
                discountForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const bookId = document.getElementById('selectBook').value;
                    const discountData = {
                        isOnSale: document.getElementById('isOnSale').checked,
                        discountPercentage: parseFloat(document.getElementById('discountPercent').value),
                        startDate: document.getElementById('discountStartDate').value,
                        endDate: document.getElementById('discountEndDate').value
                    };

                    try {
                        const response = await API.put(`/books/${bookId}/discount`, discountData);

                        if (response.success) {
                            showToast('Discount applied successfully');
                            discountForm.reset();
                            loadDiscounts();

                            // Also refresh books to show updated discount status
                            loadBooks();
                        } else {
                            showToast(response.data?.message || 'Error applying discount', 'danger');
                        }
                    } catch (error) {
                        console.error('Error applying discount:', error);
                        showToast('An error occurred while applying the discount', 'danger');
                    }
                });
            }

            // Announcement form submission
            const announcementForm = document.getElementById('announcementForm');
            if (announcementForm) {
                announcementForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const announcementId = document.getElementById('announcementId').value;
                    const announcementData = {
                        title: document.getElementById('announcementTitle').value,
                        content: document.getElementById('announcementText').value,
                        startDate: document.getElementById('announcementStartDate').value,
                        endDate: document.getElementById('announcementEndDate').value,
                        isActive: true
                    };

                    try {
                        let response;

                        if (announcementId) {
                            // Update existing announcement
                            response = await API.put(`/announcements/${announcementId}`, announcementData);
                            if (response.success) {
                                showToast('Announcement updated successfully');
                            }
                        } else {
                            // Create new announcement
                            response = await API.post('/announcements', announcementData);
                            if (response.success) {
                                showToast('Announcement created successfully');
                            }
                        }

                        if (response.success) {
                            // Reset form and refresh announcement list
                            announcementForm.reset();
                            document.getElementById('announcementId').value = '';
                            loadAnnouncements();
                        } else {
                            showToast(response.data?.message || 'Error saving announcement', 'danger');
                        }
                    } catch (error) {
                        console.error('Error saving announcement:', error);
                        showToast('An error occurred while saving the announcement', 'danger');
                    }
                });
            }

            // Delete confirmation
            const confirmDeleteBtn = document.getElementById('confirmDelete');

            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', function () {
                    if (itemToDelete) {
                        if (itemToDelete.type === 'book') {
                            deleteBook(itemToDelete.id);
                        } else if (itemToDelete.type === 'discount') {
                            removeDiscount(itemToDelete.id);
                        } else if (itemToDelete.type === 'announcement') {
                            deleteAnnouncement(itemToDelete.id);
                        }

                        deleteConfirmModal.hide();
                    }
                });
            }

            // Book search functionality
            const searchBookInput = document.getElementById('searchBook');

            if (searchBookInput) {
                searchBookInput.addEventListener('input', debounce(async function () {
                    const searchTerm = this.value.trim();

                    try {
                        let endpoint = '/books';
                        if (searchTerm) {
                            endpoint = `/books/search?term=${encodeURIComponent(searchTerm)}`;
                        }

                        const response = await API.get(endpoint);

                        if (response.success && response.data) {
                            const booksTableBody = document.querySelector('.table tbody');
                            booksTableBody.innerHTML = '';

                            if (response.data.length === 0) {
                                const row = document.createElement('tr');
                                row.innerHTML = `<td colspan="8" class="text-center">No books found</td>`;
                                booksTableBody.appendChild(row);
                            } else {
                                displayBooks(response.data);
                            }
                        }
                    } catch (error) {
                        console.error('Error searching books:', error);
                    }
                }, 300));
            }

            // Book filter functionality
            const filterBooks = document.getElementById('filterBooks');

            if (filterBooks) {
                filterBooks.addEventListener('change', async function () {
                    const filterValue = this.value;

                    try {
                        let endpoint = '/books';

                        if (filterValue === 'bestseller') {
                            endpoint = '/books/type?bestseller=true';
                        } else if (filterValue === 'newRelease') {
                            endpoint = '/books/type?newRelease=true';
                        } else if (filterValue === 'awardWinner') {
                            endpoint = '/books/type?awardWinner=true';
                        } else if (filterValue === 'lowStock') {
                            endpoint = '/books/lowstock';
                        }

                        const response = await API.get(endpoint);

                        if (response.success && response.data) {
                            const booksTableBody = document.querySelector('.table tbody');
                            booksTableBody.innerHTML = '';

                            if (response.data.length === 0) {
                                const row = document.createElement('tr');
                                row.innerHTML = `<td colspan="8" class="text-center">No books found</td>`;
                                booksTableBody.appendChild(row);
                            } else {
                                displayBooks(response.data);
                            }
                        }
                    } catch (error) {
                        console.error('Error filtering books:', error);
                    }
                });
            }

            // Initialize date inputs with current date
            const dateInputs = document.querySelectorAll('input[type="date"]');
            if (dateInputs.length > 0) {
                const today = new Date();
                const formattedDate = today.toISOString().substring(0, 10);

                dateInputs.forEach(input => {
                    if (input.id.includes('Start')) {
                        input.value = formattedDate;
                    } else if (input.id.includes('End')) {
                        // Set end date to 30 days from now
                        const endDate = new Date();
                        endDate.setDate(today.getDate() + 30);
                        input.value = endDate.toISOString().substring(0, 10);
                    }
                });
            }

            // Logout functionality
            document.getElementById('logoutLink').addEventListener('click', function (e) {
                e.preventDefault();
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            });

            // Dashboard statistics
            async function loadDashboardStats() {
                try {
                    const response = await API.get('/books/stats');

                    if (response.success) {
                        const stats = response.data;

                        // Update stats cards
                        document.getElementById('totalBooks').textContent = stats.totalBooks || 0;
                        document.getElementById('totalOrders').textContent = stats.totalOrders || 0;
                        document.getElementById('totalMembers').textContent = stats.totalMembers || 0;
                        document.getElementById('lowStockBooks').textContent = stats.lowStockBooks || 0;
                    }
                } catch (error) {
                    console.error('Error loading dashboard stats:', error);
                }
            }

            // Book management functions
            async function loadBooks() {
                try {
                    const response = await API.get('/books');

                    if (response.success && response.data) {
                        displayBooks(response.data);
                        updateBookSelectionDropdown(response.data);
                    }
                } catch (error) {
                    console.error('Error loading books:', error);
                    showToast('Failed to load books', 'danger');
                }
            }

            function displayBooks(books) {
                const booksTableBody = document.getElementById('booksTableBody');
                booksTableBody.innerHTML = '';

                if (books.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="8" class="text-center">No books found</td>`;
                    booksTableBody.appendChild(row);
                    return;
                }

                books.forEach(book => {
                    let statusBadge = '';

                    if (book.isOnSale) {
                        statusBadge = '<span class="badge bg-warning text-dark">On Sale</span>';
                    } else if (book.isBestseller) {
                        statusBadge = '<span class="badge bg-success">Bestseller</span>';
                    } else if (book.isNewRelease || (book.listedDate && new Date(book.listedDate) > new Date(Date.now() - 90 * 24 * 60 * 60 * 1000))) {
                        statusBadge = '<span class="badge bg-info">New Release</span>';
                    } else if (book.isAwardWinner) {
                        statusBadge = '<span class="badge bg-primary">Award Winner</span>';
                    } else if (book.stockQuantity < 10) {
                        statusBadge = '<span class="badge bg-danger">Low Stock</span>';
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                                <td><img src="${book.imageUrl}" class="table-image" alt="${book.title}"></td>
                                <td>${book.title}</td>
                                <td>${book.author}</td>
                                <td>${book.genre}</td>
                                <td>${book.price.toFixed(2)}</td>
                                <td>${book.stockQuantity}</td>
                                <td>${statusBadge}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1 edit-book" data-book-id="${book.id}"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-outline-danger delete-book" data-book-id="${book.id}"><i class="fas fa-trash"></i></button>
                                </td>
                            `;

                    booksTableBody.appendChild(row);
                });

                attachBookEventListeners();
            }

            async function fetchBookDetails(bookId) {
                try {
                    const response = await API.get(`/books/${bookId}`);

                    if (response.success && response.data) {
                        const book = response.data;

                        // Fill the form with book data
                        document.getElementById('bookId').value = book.id;
                        document.getElementById('title').value = book.title;
                        document.getElementById('author').value = book.author;
                        document.getElementById('isbn').value = book.isbn;
                        document.getElementById('publisher').value = book.publisher;
                        document.getElementById('publicationDate').value = formatDate(book.publicationDate);
                        document.getElementById('language').value = book.language;
                        document.getElementById('genre').value = book.genre;
                        document.getElementById('description').value = book.description;
                        document.getElementById('price').value = book.price;
                        document.getElementById('stock').value = book.stockQuantity;
                        document.getElementById('format').value = book.format;
                        document.getElementById('coverImage').value = book.imageUrl;
                        document.getElementById('isBestseller').checked = book.isBestseller;
                        document.getElementById('isNewRelease').checked = book.isNewRelease || false;
                        document.getElementById('isAwardWinner').checked = book.isAwardWinner;
                        document.getElementById('isComingSoon').checked = book.isComingSoon;

                        // Scroll to the form
                        document.getElementById('manage-books-tab').scrollIntoView({ behavior: 'smooth' });
                    } else {
                        showToast('Failed to load book details', 'danger');
                    }
                } catch (error) {
                    console.error('Error fetching book details:', error);
                    showToast('An error occurred while loading book details', 'danger');
                }
            }

            async function deleteBook(bookId) {
                try {
                    const response = await API.delete(`/books/${bookId}`);

                    if (response.success) {
                        showToast('Book deleted successfully');
                        loadBooks();
                        loadDashboardStats();
                    } else {
                        showToast(response.data?.message || 'Error deleting book', 'danger');
                    }
                } catch (error) {
                    console.error('Error deleting book:', error);
                    showToast('An error occurred while deleting the book', 'danger');
                }
            }

            function attachBookEventListeners() {
                // Edit book buttons
                document.querySelectorAll('.edit-book').forEach(button => {
                    button.addEventListener('click', function () {
                        const bookId = this.getAttribute('data-book-id');
                        fetchBookDetails(bookId);
                    });
                });

                // Delete book buttons
                document.querySelectorAll('.delete-book').forEach(button => {
                    button.addEventListener('click', function () {
                        const bookId = this.getAttribute('data-book-id');
                        itemToDelete = { type: 'book', id: bookId };
                        deleteConfirmModal.show();
                    });
                });
            }

            // Discount management functions
            async function loadDiscounts() {
                try {
                    const response = await API.get('/books/discounts');

                    if (response.success && response.data) {
                        displayDiscounts(response.data);
                    }
                } catch (error) {
                    console.error('Error loading discounts:', error);
                    showToast('Failed to load discounts', 'danger');
                }
            }

            function displayDiscounts(discounts) {
                const discountsTableBody = document.getElementById('discountsTableBody');
                discountsTableBody.innerHTML = '';

                if (discounts.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="7" class="text-center">No active discounts</td>`;
                    discountsTableBody.appendChild(row);
                    return;
                }

                discounts.forEach(discount => {
                    const now = new Date();
                    const startDate = new Date(discount.startDate);
                    const endDate = new Date(discount.endDate);

                    let status = '';
                    if (now < startDate) {
                        status = '<span class="badge bg-info">Upcoming</span>';
                    } else if (now > endDate) {
                        status = '<span class="badge bg-secondary">Expired</span>';
                    } else {
                        status = '<span class="badge bg-success">Active</span>';
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                            <td>${discount.book.title}</td>
                            <td>${discount.discountPercentage}%</td>
                            <td>${formatDate(discount.startDate)}</td>
                            <td>${formatDate(discount.endDate)}</td>
                            <td>${discount.isOnSale ? '<span class="badge bg-warning text-dark">On Sale</span>' : 'No'}</td>
                            <td>${status}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger remove-discount" data-book-id="${discount.book.id}"><i class="fas fa-times"></i></button>
                            </td>
                        `;

                    discountsTableBody.appendChild(row);
                });

                // Attach event listeners to discount removal buttons
                document.querySelectorAll('.remove-discount').forEach(button => {
                    button.addEventListener('click', function () {
                        const bookId = this.getAttribute('data-book-id');
                        itemToDelete = { type: 'discount', id: bookId };
                        deleteConfirmModal.show();
                    });
                });
            }

            async function removeDiscount(bookId) {
                try {
                    const response = await API.delete(`/books/${bookId}/discount`);

                    if (response.success) {
                        showToast('Discount removed successfully');
                        loadDiscounts();
                        loadBooks();
                    } else {
                        showToast(response.data?.message || 'Error removing discount', 'danger');
                    }
                } catch (error) {
                    console.error('Error removing discount:', error);
                    showToast('An error occurred while removing the discount', 'danger');
                }
            }

            function updateBookSelectionDropdown(books) {
                const selectBook = document.getElementById('selectBook');
                if (!selectBook) return;

                // Clear existing options except the first one
                while (selectBook.options.length > 1) {
                    selectBook.remove(1);
                }

                // Add book options
                books.forEach(book => {
                    const option = document.createElement('option');
                    option.value = book.id;
                    option.textContent = book.title;
                    selectBook.appendChild(option);
                });
            }

            // Announcement management functions
            async function loadAnnouncements() {
                try {
                    const response = await API.get('/announcements');

                    if (response.success && response.data) {
                        displayAnnouncements(response.data);
                    }
                } catch (error) {
                    console.error('Error loading announcements:', error);
                    showToast('Failed to load announcements', 'danger');
                }
            }

            function displayAnnouncements(announcements) {
                const announcementsContainer = document.getElementById('announcementsContainer');
                announcementsContainer.innerHTML = '';

                if (announcements.length === 0) {
                    announcementsContainer.innerHTML = '<p class="text-center">No announcements available</p>';
                    return;
                }

                announcements.forEach(announcement => {
                    const now = new Date();
                    const startDate = new Date(announcement.startDate);
                    const endDate = new Date(announcement.endDate);

                    let statusClass = 'bg-secondary';
                    if (now >= startDate && now <= endDate && announcement.isActive) {
                        statusClass = 'bg-success';
                    } else if (now < startDate && announcement.isActive) {
                        statusClass = 'bg-info';
                    }

                    const card = document.createElement('div');
                    card.className = 'card mb-3';
                    card.innerHTML = `
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>${announcement.title}</div>
                                <div>
                                    <span class="badge ${statusClass} me-2">${getAnnouncementStatus(announcement)}</span>
                                    <button class="btn btn-sm btn-outline-primary me-1 edit-announcement" data-announcement-id="${announcement.id}"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-outline-danger delete-announcement" data-announcement-id="${announcement.id}"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="card-text">${announcement.content}</p>
                                <p class="card-text"><small class="text-muted">Duration: ${formatDate(announcement.startDate)} to ${formatDate(announcement.endDate)}</small></p>
                            </div>
                        `;

                    announcementsContainer.appendChild(card);
                });

                // Attach event listeners
                document.querySelectorAll('.edit-announcement').forEach(button => {
                    button.addEventListener('click', function () {
                        const announcementId = this.getAttribute('data-announcement-id');
                        fetchAnnouncementDetails(announcementId);
                    });
                });

                document.querySelectorAll('.delete-announcement').forEach(button => {
                    button.addEventListener('click', function () {
                        const announcementId = this.getAttribute('data-announcement-id');
                        itemToDelete = { type: 'announcement', id: announcementId };
                        deleteConfirmModal.show();
                    });
                });
            }

            function getAnnouncementStatus(announcement) {
                const now = new Date();
                const startDate = new Date(announcement.startDate);
                const endDate = new Date(announcement.endDate);

                if (!announcement.isActive) {
                    return 'Inactive';
                } else if (now < startDate) {
                    return 'Upcoming';
                } else if (now > endDate) {
                    return 'Expired';
                } else {
                    return 'Active';
                }
            }

            async function fetchAnnouncementDetails(announcementId) {
                try {
                    const response = await API.get(`/announcements/${announcementId}`);

                    if (response.success && response.data) {
                        const announcement = response.data;

                        // Fill the form with announcement data
                        document.getElementById('announcementId').value = announcement.id;
                        document.getElementById('announcementTitle').value = announcement.title;
                        document.getElementById('announcementText').value = announcement.content;
                        document.getElementById('announcementStartDate').value = formatDate(announcement.startDate);
                        document.getElementById('announcementEndDate').value = formatDate(announcement.endDate);

                        // Scroll to the form
                        document.getElementById('manage-announcements-tab').scrollIntoView({ behavior: 'smooth' });
                    } else {
                        showToast('Failed to load announcement details', 'danger');
                    }
                } catch (error) {
                    console.error('Error fetching announcement details:', error);
                    showToast('An error occurred while loading announcement details', 'danger');
                }
            }

            async function deleteAnnouncement(announcementId) {
                try {
                    const response = await API.delete(`/announcements/${announcementId}`);

                    if (response.success) {
                        showToast('Announcement deleted successfully');
                        loadAnnouncements();
                    } else {
                        showToast(response.data?.message || 'Error deleting announcement', 'danger');
                    }
                } catch (error) {
                    console.error('Error deleting announcement:', error);
                    showToast('An error occurred while deleting the announcement', 'danger');
                }
            }

            // User setup
            function setupUserInfo() {
                const userJSON = localStorage.getItem('user');
                if (userJSON) {
                    try {
                        const user = JSON.parse(userJSON);
                        document.getElementById('userName').textContent = user.name || 'Admin User';
                        // Update avatar if needed
                        if (user.avatarUrl) {
                            document.getElementById('userAvatar').src = user.avatarUrl;
                        }
                    } catch (e) {
                        console.error('Error parsing user data:', e);
                    }
                }
            }
        });
    </script>
</body>
</html>
